<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bay Area Transit Tracker</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { 
            font-family: -apple-system, system-ui, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        header {
            background-color: #3b5998;
            color: white;
            padding: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        button {
            background-color: rgba(255,255,255,0.2);
            border: 1px solid white;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
        }
        main {
            display: flex;
            flex: 1;
            position: relative;
            overflow: hidden;
        }
        #map {
            height: 100%;
            width: 100%;
        }
        .sidebar {
            width: 250px;
            background-color: #f5f5f5;
            position: absolute;
            right: 0;
            top: 0;
            height: 100%;
            overflow-y: auto;
            box-shadow: -2px 0 5px rgba(0,0,0,0.1);
            padding: 1rem;
            transform: translateX(0);
            transition: transform 0.3s ease;
            z-index: 1000;
        }
        .sidebar.hidden {
            transform: translateX(100%);
        }
        h2, h3 {
            margin-bottom: 1rem;
        }
        .filter-section {
            margin-bottom: 1.5rem;
        }
        .agency-list {
            list-style: none;
        }
        .agency-item {
            display: flex;
            align-items: center;
            margin-bottom: 0.5rem;
        }
        .agency-color {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 0.5rem;
        }
        select {
            width: 100%;
            padding: 0.5rem;
            margin-top: 0.5rem;
            border-radius: 4px;
            border: 1px solid #ccc;
        }
        .error {
            background-color: #ffeeee;
            border: 1px solid #ffcccc;
            padding: 0.5rem;
            margin-bottom: 1rem;
            border-radius: 4px;
            display: none;
        }
        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 1rem;
            border-radius: 4px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            display: none;
            z-index: 9999;
        }
        .status-bar {
            background-color: #f0f0f0;
            padding: 0.5rem 1rem;
            display: flex;
            justify-content: space-between;
            font-size: 0.9rem;
        }
        @media (prefers-color-scheme: dark) {
            .sidebar { background-color: #333; color: #f0f0f0; }
            .status-bar { background-color: #222; color: #f0f0f0; }
            select { background-color: #444; color: white; border-color: #555; }
            .error { background-color: #442222; color: #ffcccc; border-color: #663333; }
            .loading { background-color: #333; color: white; }
        }
    </style>
</head>
<body>
    <header>
        <h1>Bay Area Transit Tracker</h1>
        <div>
            <button id="refresh-btn">Refresh</button>
            <button id="toggle-panel">Panel</button>
        </div>
    </header>
    
    <main>
        <div id="map"></div>
        
        <div id="sidebar" class="sidebar">
            <div id="error-message" class="error">
                Error connecting to transit API. Showing demo data.
            </div>
            
            <div class="filter-section">
                <h2>Transit Filters</h2>
                <label for="county-select">County:</label>
                <select id="county-select">
                    <option value="all">All Counties</option>
                    <option value="sf" selected>San Francisco</option>
                    <option value="alameda">Alameda</option>
                    <option value="contra-costa">Contra Costa</option>
                    <option value="san-mateo">San Mateo</option>
                    <option value="santa-clara">Santa Clara</option>
                    <option value="marin">Marin</option>
                    <option value="sonoma">Sonoma</option>
                    <option value="napa">Napa</option>
                    <option value="solano">Solano</option>
                </select>
            </div>
            
            <div class="filter-section">
                <h3>Transit Agencies</h3>
                <ul id="agency-list" class="agency-list">
                    <!-- Dynamically populated -->
                </ul>
            </div>
        </div>
        
        <div id="loading" class="loading">Loading transit data...</div>
    </main>
    
    <div class="status-bar">
        <span id="last-update">Last updated: Never</span>
        <span id="vehicle-count">0 vehicles tracked</span>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // API Key
            const API_KEY = '825a0905-cdd2-4179-b699-f5f46b26528e';
            
            // Elements
            const map = L.map('map').setView([37.77, -122.42], 13);
            const sidebar = document.getElementById('sidebar');
            const togglePanel = document.getElementById('toggle-panel');
            const refreshBtn = document.getElementById('refresh-btn');
            const agencyList = document.getElementById('agency-list');
            const countySelect = document.getElementById('county-select');
            const loading = document.getElementById('loading');
            const errorMessage = document.getElementById('error-message');
            const lastUpdate = document.getElementById('last-update');
            const vehicleCount = document.getElementById('vehicle-count');
            
            // Map layers
            const vehicleLayer = L.layerGroup().addTo(map);
            
            // Adding tile layer
            L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
                subdomains: 'abcd',
                maxZoom: 19
            }).addTo(map);
            
            // Toggle sidebar
            togglePanel.addEventListener('click', function() {
                sidebar.classList.toggle('hidden');
            });
            
            // Counties data
            const counties = {
                'sf': { center: [37.77, -122.42], zoom: 13 },
                'alameda': { center: [37.60, -122.00], zoom: 11 },
                'contra-costa': { center: [37.96, -121.97], zoom: 10 },
                'san-mateo': { center: [37.50, -122.33], zoom: 11 },
                'santa-clara': { center: [37.35, -121.96], zoom: 10 },
                'marin': { center: [38.08, -122.76], zoom: 10 },
                'sonoma': { center: [38.58, -122.99], zoom: 9 },
                'napa': { center: [38.50, -122.27], zoom: 10 },
                'solano': { center: [38.31, -121.90], zoom: 10 },
                'all': { center: [37.83, -122.29], zoom: 9 }
            };
            
            // Major transit agencies
            const agencies = [
                { id: 'BA', name: 'BART', color: '#0099cc' },
                { id: 'SF', name: 'SF Muni', color: '#e61919' },
                { id: 'AC', name: 'AC Transit', color: '#4db848' },
                { id: 'CT', name: 'Caltrain', color: '#e6291f' },
                { id: 'SM', name: 'SamTrans', color: '#cb3927' },
                { id: 'GG', name: 'Golden Gate Transit', color: '#ff5f00' },
                { id: 'SC', name: 'VTA', color: '#6699cc' }
            ];
            
            let activeAgencies = new Set(agencies.map(a => a.id));
            
            // Populate agency list
            agencies.forEach(agency => {
                const li = document.createElement('li');
                li.className = 'agency-item';
                
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.id = `agency-${agency.id}`;
                checkbox.checked = true;
                checkbox.dataset.agency = agency.id;
                
                const color = document.createElement('span');
                color.className = 'agency-color';
                color.style.backgroundColor = agency.color;
                
                const label = document.createElement('label');
                label.htmlFor = `agency-${agency.id}`;
                label.textContent = agency.name;
                
                checkbox.addEventListener('change', function() {
                    if (this.checked) {
                        activeAgencies.add(agency.id);
                    } else {
                        activeAgencies.delete(agency.id);
                    }
                    refreshVehicles();
                });
                
                li.appendChild(checkbox);
                li.appendChild(color);
                li.appendChild(label);
                agencyList.appendChild(li);
            });
            
            // County selection
            countySelect.addEventListener('change', function() {
                const county = counties[this.value] || counties.all;
                map.setView(county.center, county.zoom);
            });
            
            // Create marker icon
            function createVehicleIcon(color) {
                return L.divIcon({
                    className: 'vehicle-icon',
                    html: `<div style="background-color: ${color}; width: 10px; height: 10px; border-radius: 50%; border: 2px solid white;"></div>`,
                    iconSize: [10, 10],
                    iconAnchor: [5, 5]
                });
            }
            
            // Process data from 511.org API
            function processVehicleData(data) {
                try {
                    // Parse the data and extract vehicle positions
                    // If data is in JSON, we parse it directly
                    // This is a simplified version - in practice, we'd need proper parsing for the format
                    if (typeof data === 'string') {
                        data = JSON.parse(data);
                    }
                    
                    let vehicles = [];
                    
                    // Basic data structure for vehicles with position data
                    if (data.entity && Array.isArray(data.entity)) {
                        data.entity.forEach(entity => {
                            if (entity.vehicle && entity.vehicle.position) {
                                const v = entity.vehicle;
                                
                                // Try to extract agency ID
                                let agencyId = 'UNKNOWN';
                                if (v.trip && v.trip.routeId) {
                                    // Often the route ID has agency prefix
                                    const routeParts = v.trip.routeId.split('-');
                                    if (routeParts.length > 0 && agencies.some(a => a.id === routeParts[0])) {
                                        agencyId = routeParts[0];
                                    }
                                }
                                
                                // Only include active agencies
                                if (activeAgencies.has(agencyId)) {
                                    const agency = agencies.find(a => a.id === agencyId) || 
                                                  { name: 'Unknown', color: '#999' };
                                    
                                    vehicles.push({
                                        id: entity.id || `vehicle-${Math.random().toString(36).substring(2, 9)}`,
                                        agency: agencyId,
                                        position: {
                                            lat: v.position.latitude, 
                                            lng: v.position.longitude
                                        },
                                        color: agency.color,
                                        name: agency.name,
                                        route: v.trip ? v.trip.routeId : 'Unknown'
                                    });
                                }
                            }
                        });
                    }
                    
                    return vehicles;
                } catch (error) {
                    console.error('Error processing vehicle data:', error);
                    return [];
                }
            }
            
            // Fetch vehicle data from API
            async function fetchVehicleData() {
                errorMessage.style.display = 'none';
                loading.style.display = 'block';
                
                try {
                    const response = await fetch(`https://api.511.org/transit/vehiclepositions?api_key=${API_KEY}&agency=RG`);
                    
                    if (!response.ok) {
                        throw new Error(`API error: ${response.status}`);
                    }
                    
                    const data = await response.text();
                    
                    // The response might be in protobuf format
                    // For simplicity, we'll try to parse as JSON first
                    try {
                        const jsonData = JSON.parse(data);
                        const vehicles = processVehicleData(jsonData);
                        updateVehicles(vehicles);
                    } catch (jsonError) {
                        console.error('Error parsing JSON:', jsonError);
                        // If JSON parse fails, it might be protobuf
                        // In a real app, we'd use a protobuf library to decode it
                        // For now, just show demo data
                        fetchDemoData();
                    }
                    
                } catch (error) {
                    console.error('Error fetching data:', error);
                    errorMessage.style.display = 'block';
                    fetchDemoData();
                } finally {
                    loading.style.display = 'none';
                }
            }
            
            // Fetch demo data
            function fetchDemoData() {
                const vehicles = generateDemoVehicles();
                updateVehicles(vehicles);
            }
            
            // Generate demo vehicles
            function generateDemoVehicles() {
                const vehicles = [];
                const bounds = {
                    sf: { 
                        lat: { min: 37.70, max: 37.84 },
                        lng: { min: -122.51, max: -122.38 }
                    },
                    east_bay: {
                        lat: { min: 37.70, max: 37.90 },
                        lng: { min: -122.30, max: -122.10 }
                    }
                };
                
                // Generate a few vehicles for each agency
                agencies.forEach(agency => {
                    const count = Math.floor(Math.random() * 8) + 3;
                    
                    for (let i = 0; i < count; i++) {
                        // Select area based on agency
                        const area = (agency.id === 'SF') ? bounds.sf : 
                                    (agency.id === 'AC' || agency.id === 'BA') ? bounds.east_bay : 
                                    Math.random() > 0.5 ? bounds.sf : bounds.east_bay;
                        
                        const lat = area.lat.min + Math.random() * (area.lat.max - area.lat.min);
                        const lng = area.lng.min + Math.random() * (area.lng.max - area.lng.min);
                        
                        vehicles.push({
                            id: `${agency.id}-demo-${i}`,
                            agency: agency.id,
                            position: { lat, lng },
                            color: agency.color,
                            name: agency.name,
                            route: `${agency.id}-${Math.floor(Math.random() * 100)}`
                        });
                    }
                });
                
                return vehicles;
            }
            
            // Update vehicles on the map
            function updateVehicles(vehicles) {
                // Clear existing vehicles
                vehicleLayer.clearLayers();
                
                // Add new vehicles
                vehicles.forEach(vehicle => {
                    if (activeAgencies.has(vehicle.agency)) {
                        const marker = L.marker([vehicle.position.lat, vehicle.position.lng], {
                            icon: createVehicleIcon(vehicle.color)
                        });
                        
                        marker.bindPopup(`
                            <strong>${vehicle.name}</strong><br>
                            Route: ${vehicle.route}
                        `);
                        
                        vehicleLayer.addLayer(marker);
                    }
                });
                
                // Update status
                const now = new Date();
                lastUpdate.textContent = `Last updated: ${now.toLocaleTimeString()}`;
                vehicleCount.textContent = `${vehicles.length} vehicles tracked`;
            }
            
            // Refresh vehicles
            function refreshVehicles() {
                fetchVehicleData();
            }
            
            // Set initial county view
            const defaultCounty = counties[countySelect.value] || counties.sf;
            map.setView(defaultCounty.center, defaultCounty.zoom);
            
            // Refresh button
            refreshBtn.addEventListener('click', refreshVehicles);
            
            // Initial data fetch
            fetchVehicleData();
            
            // Auto-refresh every 30 seconds
            setInterval(fetchVehicleData, 30000);
        });
    </script>
</body>
</html>
